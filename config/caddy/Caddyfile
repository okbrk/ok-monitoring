# Caddy configuration with automatic HTTPS
# Admin services (Grafana) are NOT exposed - access via Tailscale VPN only

{
  # Global options
  email admin@{$DOMAIN}

  # Enable admin API for metrics on port 2019 (VPN-only)
  admin :2019

  # Enable Prometheus metrics
  servers {
    metrics
  }
}

# API endpoints for customer data ingestion - PUBLIC
https://api.{$DOMAIN} {
  # CORS headers for browser-based integrations
  @cors_preflight method OPTIONS
  handle @cors_preflight {
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "POST, GET, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, X-Scope-OrgID, Authorization"
    header Access-Control-Max-Age "3600"
    respond 204
  }

  # Add CORS headers to all responses
  header Access-Control-Allow-Origin "*"
  header Access-Control-Allow-Methods "POST, GET, OPTIONS"
  header Access-Control-Allow-Headers "Content-Type, X-Scope-OrgID, Authorization"

  # OTLP HTTP endpoints for traces, metrics, and logs
  handle /v1/traces {
    reverse_proxy otel-collector:4318
  }

  handle /v1/metrics {
    reverse_proxy otel-collector:4318
  }

  handle /v1/logs {
    reverse_proxy otel-collector:4318
  }

  # Loki push endpoint (for Promtail, Fluentd, etc.)
  handle /loki/api/v1/push {
    reverse_proxy loki:3100
  }

  # Mimir remote write endpoint (for Prometheus)
  handle /api/v1/push {
    reverse_proxy mimir:8080
  }

  # Tempo OTLP endpoint (alternative)
  handle /tempo/* {
    reverse_proxy tempo:4318
  }

  # Health check endpoint - public (for monitoring)
  handle /health {
    respond "OK" 200
  }

  # Default: deny all other requests
  handle {
    respond "Unauthorized" 401
  }
}

# OTLP gRPC endpoint - PUBLIC
https://otlp.{$DOMAIN} {
  reverse_proxy h2c://otel-collector:4317
}

# Grafana and admin dashboard - NOT EXPOSED
# Access these services via Tailscale VPN at:
#   http://<tailscale-ip>:3000 - Grafana
#   http://<tailscale-ip>:3001 - Admin Dashboard (future)
#
# Note: Grafana is accessible on the Docker network but NOT via public internet

